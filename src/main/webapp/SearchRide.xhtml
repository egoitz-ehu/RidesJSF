<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	template="/WEB-INF/facelets/templates/Txantiloia.xhtml">

	<ui:define name="scripts">
		<h:outputScript library="js" name="calendar.js" />
	</ui:define>

	<ui:define name="styles">
		<h:outputStylesheet library="css" name="searchRide.css" />
	</ui:define>

	<ui:define name="content">
		<f:event type="postAddToView"
			listener="#{languageBean.initializeLocaleForView}" />
		<f:event type="preRenderView" listener="#{searchRideBean.init}" />

		<div class="main-container">
			<p:card styleClass="search-card">
				<f:facet name="title">
					<i class="pi pi-search"></i> #{msg['fetchRide.title']}
                </f:facet>
				<h:form id="searchForm">
					<h:inputHidden id="activeDatesData"
						value="#{searchRideBean.availableDatesStr}" />
					<div class="ui-g ui-fluid">
						<!-- First row: two columns for selects -->
						<div class="ui-g-12 ui-md-6">
							<p:outputLabel for="departingCity"
								value="#{msg['fetchRide.departingCity']}" />
							<p:selectOneMenu id="departingCity"
								value="#{searchRideBean.departingCity}" filter="true"
								filterMatchMode="startsWith" emptyLabel="Select departing city">
								<f:selectItem
									itemLabel="#{msg['fetchRide.selectDepartingCity']}"
									itemValue="" />
								<f:selectItems value="#{searchRideBean.departingCities}" />
								<p:ajax event="change"
									listener="#{searchRideBean.onDepartingCityChange}"
									update="arrivalCity" />
							</p:selectOneMenu>
						</div>
						<div class="ui-g-12 ui-md-6">
							<p:outputLabel for="arrivalCity"
								value="#{msg['fetchRide.arrivalCity']}" />
							<p:selectOneMenu id="arrivalCity"
								value="#{searchRideBean.arrivalCity}" filter="true"
								filterMatchMode="startsWith" emptyLabel="Select arrival city">
								<f:selectItem itemLabel="#{msg['fetchRide.selectArrivalCity']}"
									itemValue="" />
								<f:selectItems value="#{searchRideBean.arrivalCities}" />
								<p:ajax event="change"
									listener="#{searchRideBean.onArrivalCityChange}"
									update="rideDate activeDatesData"
									oncomplete="$('#searchForm\\:rideDate').datepicker('refresh');" />
							</p:selectOneMenu>
						</div>
						<!-- Second row: one column for calendar -->
						<div class="ui-g-12">
							<p:outputLabel for="rideDate" value="#{msg['fetchRide.date']}" />
							<p:calendar id="rideDate" value="#{searchRideBean.rideDate}"
								mode="inline" showButtonPanel="true"
								beforeShowDay="egunakAztertu">
								<p:ajax event="viewChange"
									listener="#{searchRideBean.onMonthChange}" />
							</p:calendar>
						</div>
					</div>
					<div style="text-align: center; margin-top: 20px;">
						<p:commandButton value="#{msg['fetchRide.searchButton']}"
							icon="pi pi-search" styleClass="ui-button-success"
							action="#{searchRideBean.searchRides}"
							update="resultsPanel messages" />
					</div>
				</h:form>
			</p:card>

			<p:messages id="messages" showDetail="true" closable="true" />
			<h:panelGroup id="resultsPanel">
				<ui:repeat value="#{searchRideBean.results}" var="ride">
					<p:card styleClass="ride-card">
						<f:facet name="title">
							<div
								style="display: flex; justify-content: space-between; align-items: center;">
								<span> <i class="pi pi-user"></i> #{ride.driver.name}
								</span>
								<p:badge value="#{ride.pricePerSeat} €" severity="success"
									size="large" />
							</div>
						</f:facet>
						<div class="p-grid">
							<div class="p-col-6">
								<i class="pi pi-users"></i> <strong>#{msg['fetchRide.seats']}:</strong>
								#{ride.availableSeats}
							</div>
							<div class="p-col-6" style="text-align: right;">
								<p:commandButton value="#{msg['fetchRide.bookButton']}"
									icon="pi pi-check" styleClass="ui-button-sm ui-button-outlined"
									action="#{searchRideBean.prepareBooking(ride)}"
									oncomplete="PF('bookingDialog').show()" update="bookingDialog" />
							</div>
						</div>
					</p:card>
				</ui:repeat>
			</h:panelGroup>
			<p:dialog id="bookingDialog" widgetVar="bookingDialog"
				header="#{msg['booking.title']}" modal="true" width="500"
				resizable="false">

				<h:panelGrid columns="2" cellpadding="10">
					<h:outputText value="#{msg['booking.from']}: " />
					<h:outputText value="#{searchRideBean.selectedRide.departingCity}" />

					<h:outputText value="#{msg['booking.to']}: " />
					<h:outputText value="#{searchRideBean.selectedRide.arrivalCity}" />

					<h:outputText value="#{msg['booking.date']}: " />
					<h:outputText value="#{searchRideBean.selectedRide.rideDate}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<h:outputText value="#{msg['booking.pricePerSeat']}: " />
					<h:outputText value="#{searchRideBean.selectedRide.pricePerSeat} €" />

					<h:outputText value="#{msg['booking.seats']}: " />
					<p:spinner value="#{searchRideBean.numberOfSeats}" min="1"
						max="#{searchRideBean.selectedRide.availableSeats}"
						styleClass="w-full">
						<p:ajax event="change" update="totalPrice"
							listener="#{searchRideBean.calculateTotal}" />
					</p:spinner>

					<h:outputText value="#{msg['booking.total']}: "
						style="font-weight: bold;" />
					<h:outputText id="totalPrice"
						value="#{searchRideBean.totalPrice} €" style="font-weight: bold;" />
				</h:panelGrid>

				<f:facet name="footer">
					<p:commandButton value="#{msg['booking.confirm']}"
						icon="pi pi-check" action="#{searchRideBean.confirmBooking}"
						update="messages"
						oncomplete="if(args.success) PF('bookingDialog').hide()" />
					<p:commandButton value="#{msg['booking.cancel']}"
						icon="pi pi-times" onclick="PF('bookingDialog').hide()"
						styleClass="ui-button-secondary" />
				</f:facet>
			</p:dialog>

		</div>
	</ui:define>
</ui:composition>